#!/usr/bin/env node

var program = require('commander')
	, fs = require('fs')
	, path = require('path')
	, indent = require('buddy-term').indent
	, Builder = require('../lib/builder');

var exampleHeader = [
	'  Configuration:'
	, ''
	, '    build, dependencies, and plugin settings are defined in a "buddy.js" config file'
	, '    that should be located in the root of your project directory:'
	, ''

	].join('\n')
	, exampleFooter = [
	''
	, '    Visit https://github.com/popeindustries/buddy#readme for more details.'
	, ''
	].join('\n');

program
	.version(require('../package.json').version)
	.usage('[options] <command> [path/to/buddy.json]>')
	.option('-c, --compress', 'compress output for production deployment')
	.option('-l, --lint', 'check output for syntax and logic errors')
	.option('-r, --reload', 'reload all connected live-reload clients on file change during watch')
	.option('-t, --test', 'run test command on build completion')
	.option('-L, --lazy', 'convert js modules for lazy evaluation')
	.option('-v, --verbose', 'print all messages for debugging');

program
	.command('install [config]')
	.description('install dependencies')
	.action(function(config) {
		new Builder().install(config, program.verbose);
	});

program
	.command('build [config]')
	.description('build js and css sources')
	.action(function(config){
		new Builder().build(config, program.compress, program.lint, program.test, program.lazy, program.verbose);
	});

program
	.command('watch [config]')
	.description('watch js and css source files and build changes')
	.action(function(config){
		new Builder().watch(config, program.compress, program.reload, program.test, program.lazy, program.verbose);
	});

program
	.command('deploy [config]')
	.description('build compressed js and css sources')
	.action(function(config){
		new Builder().deploy(config, program.test, program.lazy, program.verbose);
	});

program
	.command('ls')
	.description('list all previously created files and directories')
	.action(function(){
		new Builder().list(program.verbose);
	});

program
	.command('clean')
	.description('remove all previously created files and directories')
	.action(function(){
		new Builder().clean(program.verbose);
	});

program.on('--help', function(){
  console.log(exampleHeader);
  console.log(indent(fs.readFileSync(path.resolve(__dirname, '../buddy.js'), 'utf8'), 4));
  console.log(exampleFooter);
});

program.parse(process.argv);