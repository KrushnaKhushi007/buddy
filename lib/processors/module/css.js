// Generated by CoffeeScript 1.4.0
var RE_COMMENT_LINES, RE_IMPORT, RE_WIN_SEPARATOR, path;

path = require('path');

RE_WIN_SEPARATOR = /\\\\?/g;

RE_IMPORT = /@import\s['|"](.*?)['|"];?/g;

RE_COMMENT_LINES = /((?:\/\*(?:[^*]|(?:\*+[^*\/]))*\*+\/)|(?:\/\/.*))$/gm;

module.exports = {
  name: 'css',
  category: 'css',
  type: 'module',
  getModuleID: function(qualifiedFilename) {
    var module;
    module = qualifiedFilename.toLowerCase();
    if (process.platform === 'win32') {
      module = module.replace(RE_WIN_SEPARATOR, '/');
    }
    return module;
  },
  getModuleDependencies: function(content, id) {
    var dep, deps, match, part, parts, _i, _len, _ref;
    deps = [];
    content = content.replace(RE_COMMENT_LINES, '');
    while (match = RE_IMPORT.exec(content)) {
      dep = match[1].replace('.css', '');
      if (dep.indexOf('/') === -1) {
        dep = './' + dep;
      }
      parts = dep.split('/');
      if (dep.charAt(0) === '.') {
        parts = id.split('/');
        parts.pop();
        _ref = dep.split('/');
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          part = _ref[_i];
          if (part === '..') {
            parts.pop();
          } else if (part !== '.') {
            parts.push(part);
          }
        }
      }
      deps.push(parts.join('/'));
    }
    return deps;
  },
  wrapModuleContents: function(content, id) {
    return content;
  },
  concat: function(file) {
    var inline;
    inline = function(file, content) {
      file.dependencies.forEach(function(dependency) {
        var id, inlineContent, re;
        inlineContent = dependency.dependencies.length ? inline(dependency, dependency.content) : dependency.content;
        id = dependency.moduleID.split('/').reverse()[0];
        re = new RegExp("^@import\\s['|\"](?:\\.\\/)?(?:\\w*\/)?" + id + "(?:\\.css)?['|\"];?\\s*$", 'im');
        return content = content.replace(re, inlineContent + '\n');
      });
      return content;
    };
    return inline(file, file.content).replace(RE_COMMENT_LINES, '');
  }
};
